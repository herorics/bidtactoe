<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bid Tac Toe — Human vs Human</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --ok:#34d399; --warn:#fbbf24; --danger:#f87171; --bd:#1f2937 }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#0b0f14; color:var(--text)}
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
    h1{margin:.2rem 0 .4rem; font-size:28px}
    .sub{color:var(--muted); font-size:14px}
    .layout{display:grid; grid-template-columns: 1fr 420px; gap:16px; align-items:start}
    .panel{background:linear-gradient(180deg,#111827,#0f172a); border:1px solid var(--bd); border-radius:16px; padding:14px}

    /* Board */
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; width:min(520px,100%); margin:8px 0}
    .cell{aspect-ratio:1/1; border:1px solid var(--bd); border-radius:16px; background:#0b1220; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:56px; user-select:none; transition:transform .06s ease, box-shadow .06s ease}
    .cell.empty{color:#64748b}
    .cell.x{color:#22d3ee; text-shadow:0 0 12px rgba(34,211,238,.65), 0 2px 0 rgba(0,0,0,.35)}
    .cell.o{color:#fbbf24; text-shadow:0 0 12px rgba(251,191,36,.65), 0 2px 0 rgba(0,0,0,.35)}
    .cell.disabled{opacity:.8; cursor:not-allowed}
    .cell.placeable{cursor:pointer; box-shadow:0 0 0 2px rgba(34,211,238,.35), 0 0 18px rgba(34,211,238,.25)}
    .cell.placeable:hover{transform:translateY(-1px);}

    .badge{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--bd); background:#0b1220; font-size:12px}
    .muted{color:var(--muted)}
    .btn{background:#0ea5e9; border:none; color:#fff; font-weight:700; padding:10px 14px; border-radius:12px; cursor:pointer}
    .btn.secondary{background:#374151}
    .btn.warn{background:#f59e0b}
    .btn.ghost{background:transparent; border:1px solid var(--bd)}
    .field{display:flex; gap:8px; align-items:center}
    input, textarea, select{background:#0b1220; border:1px solid #243043; color:#e5e7eb; border-radius:10px; padding:10px 12px; width:100%}
    .stack{display:flex; flex-direction:column; gap:12px}
    .log{font-family:ui-monospace,Menlo,Consolas,monospace; background:#0b1220; border:1px solid var(--bd); border-radius:12px; padding:10px; height:140px; overflow:auto}
    details{background:#0b1220; border:1px solid #243043; border-radius:12px; padding:10px}

    /* Right column sections */
    .right .section{margin-bottom:14px}
    .right .section:last-child{margin-bottom:0}
  </style>
  <script defer src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Bid Tac Toe — Human vs Human</h1>
    <div class="sub">Auction Tic‑Tac‑Toe. Both start with same budget (default $100). <b>Step 1</b>: both secretly bid. <b>Step 2</b>: the higher bid winner clicks a cell to place their mark. <b>Both</b> pay their own bid. Ties decide by coin toss.</div>

    <div class="layout">
      <!-- LEFT: Board -->
      <div class="panel">
        <div class="badge">Board</div>
        <div id="board" class="grid" aria-label="board"></div>
        <div id="status" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- RIGHT: Controls + Rules (rules at bottom) -->
      <div class="right">
        <div class="panel section">
          <div class="badge">Online（輸入相同 Key 即可連）</div>
          <div class="stack">
            <div class="field"><label style="width:140px">Room Key</label><input id="roomKey" placeholder="例如: SUNNY88"/></div>
            <div class="field"><label style="width:140px">Share Link</label><input id="shareLink" readonly placeholder="建立後自動產生"/></div>
            <div class="row" style="display:flex; gap:8px"><button id="btnHost" class="btn">Host</button><button id="btnJoin" class="btn secondary">Join</button></div>
            <div id="rtcState" class="muted">Offline</div>
          </div>
        </div>

        <div class="panel section">
          <div class="badge">Bidding</div>
          <div class="stack">
            <div class="field"><label style="width:120px">Player X bid</label><input id="bidX" type="number" min="0" step="0.01" placeholder="0"/></div>
            <div class="field"><label style="width:120px">Player O bid</label><input id="bidO" type="number" min="0" step="0.01" placeholder="0"/></div>
            <div class="row" style="display:flex; gap:8px"><button id="btnLockBids" class="btn">Lock & Reveal</button><button id="btnUndo" class="btn ghost">Undo</button></div>
            <div class="muted" id="hint">Enter bids then click Lock & Reveal.</div>
          </div>
        </div>

        <div class="panel section">
          <div class="badge">Match</div>
          <div class="row" style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap">
            <div style="flex:1 1 150px">
              <div>Player <b>X</b> budget: $<span id="moneyX">100</span></div>
              <div>Player <b>O</b> budget: $<span id="moneyO">100</span></div>
            </div>
            <div style="flex:1 1 200px" class="stack">
              <div class="field"><label style="width:120px">Start Budget</label><input id="startBudget" type="number" value="100" min="1"/></div>
              <div class="field"><label style="width:120px">First Player</label><select id="firstPlayer"><option>X</option><option>O</option></select></div>
              <div class="row" style="display:flex; gap:8px"><button id="btnNew" class="btn warn">New Match</button><button id="btnExport" class="btn ghost">Export</button><button id="btnImport" class="btn ghost">Import</button></div>
            </div>
          </div>
          <div style="margin-top:10px"><div class="badge">Event Log</div><div id="log" class="log"></div></div>
        </div>

        <div class="panel section">
          <div class="badge">Rules</div>
          <ol>
            <li>Both start with same budget.</li>
            <li><b>Reveal stage</b>: both submit bids, click <b>Lock & Reveal</b>.</li>
            <li><b>Placement stage</b>: the winner is prompted to <u>click an empty cell</u> to place X or O. <b>Both</b> pay their bid.</li>
            <li>Tie → coin toss (auto).</li>
            <li>First 3‑in‑a‑row wins; full board with no line = draw.</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <script>
  ;(()=>{
    const $ = s=>document.querySelector(s);
    const boardEl = $('#board');
    const statusEl = $('#status');
    const logEl = $('#log');
    const hintEl = $('#hint');
    const moneyXEl = $('#moneyX');
    const moneyOEl = $('#moneyO');
    const bidXEl = $('#bidX');
    const bidOEl = $('#bidO');

    const btnLock=$('#btnLockBids');
    const btnUndo=$('#btnUndo');
    const btnNew=$('#btnNew');
    const startBudgetEl=$('#startBudget');
    const firstPlayerEl=$('#firstPlayer');
    const btnExport=$('#btnExport');
    const btnImport=$('#btnImport');

    const roomKeyEl=$('#roomKey');
    const shareLinkEl=$('#shareLink');
    const btnHost=$('#btnHost');
    const btnJoin=$('#btnJoin');
    const rtcState=$('#rtcState');

    let S = { board:Array(9).fill(''), turn:'X', money:{X:100,O:100}, history:[], finished:false, pending:null };

    function render(){
      boardEl.innerHTML='';
      S.board.forEach((v,i)=>{
        const d=document.createElement('div');
        const placeable = !v && !S.finished && !!S.pending; // winner is choosing a cell
        d.className='cell'+(v?' '+(v==='X'?'x':'o'):' empty')+(S.finished?' disabled':'')+(placeable?' placeable':'');
        d.textContent=v||i;
        d.addEventListener('click',()=>{
          if(placeable){
            // placement step
            S.board[i] = S.pending.winner;
            // record after placement
            S.history.push({bx:S.pending.bx, bo:S.pending.bo, winner:S.pending.winner, cell:i, turn:S.turn});
            const w=checkWin();
            if(w==='X'||w==='O'){ S.finished=true; log(`<b>${w}</b> wins!`); }
            else if(w==='D'){ S.finished=true; log('Draw.'); }
            else{ S.turn = (S.turn==='X'?'O':'X'); }
            S.pending=null;
            bidXEl.disabled=false; bidOEl.disabled=false; btnLock.disabled=false;
            hintEl.textContent='Enter bids then click Lock & Reveal.';
            render();
          }
        });
        boardEl.appendChild(d);
      });
      moneyXEl.textContent=S.money.X.toFixed(2);
      moneyOEl.textContent=S.money.O.toFixed(2);
      statusEl.textContent=S.finished? 'Match finished' : (S.pending? `Winner: ${S.pending.winner} — click a cell to place` : `Turn: ${S.turn}`);
      sync();
    }

    function log(m){ const t=new Date().toLocaleTimeString(); logEl.insertAdjacentHTML('beforeend',`[${t}] ${m}<br/>`); logEl.scrollTop=logEl.scrollHeight; }
    function lines(){return [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]}
    function checkWin(){ for(const [a,b,c] of lines()) if(S.board[a]&&S.board[a]===S.board[b]&&S.board[a]===S.board[c]) return S.board[a]; if(S.board.every(x=>x)) return 'D'; return '' }
    const toss=()=>Math.random()<.5?'X':'O';

    function lockReveal(){
      if(S.finished) return;
      if(S.pending) return alert('Place your mark first.');
      const bx=parseFloat(bidXEl.value||'0');
      const bo=parseFloat(bidOEl.value||'0');
      if([bx,bo].some(x=>isNaN(x)||x<0)) return alert('Bids must be non‑negative');
      if(bx>S.money.X||bo>S.money.O) return alert('Bid exceeds budget');
      const winner = bx>bo? 'X' : bo>bx? 'O' : toss();
      // pay immediately
      S.money.X-=bx; S.money.O-=bo;
      S.pending = {winner, bx, bo};
      log(`Reveal — X:$${bx.toFixed(2)} O:$${bo.toFixed(2)} ⇒ <b>${winner}</b> to place`);
      // disable bidding inputs during placement
      bidXEl.disabled=true; bidOEl.disabled=true; btnLock.disabled=true; hintEl.textContent=`${winner} is choosing a cell…`;
      // clear inputs for next round
      bidXEl.value=''; bidOEl.value='';
      render();
    }

    function undo(){
      if(S.pending){
        // undo the reveal before placement: refund bids
        S.money.X += S.pending.bx; S.money.O += S.pending.bo; log('Undo reveal — bids refunded.'); S.pending=null; bidXEl.disabled=false; bidOEl.disabled=false; btnLock.disabled=false; hintEl.textContent='Enter bids then click Lock & Reveal.'; render();
        return;
      }
      const r=S.history.pop(); if(!r) return;
      S.board[r.cell]=''; S.money.X+=r.bx; S.money.O+=r.bo; S.turn=r.turn; S.finished=false; render(); log('Undo last turn.');
    }

    function newMatch(){ const b=Math.max(1,parseFloat(startBudgetEl.value||'100')); S={board:Array(9).fill(''),turn:firstPlayerEl.value,money:{X:b,O:b},history:[],finished:false,pending:null}; render(); log('— New match —'); }

    btnLock.addEventListener('click', lockReveal);
    btnUndo.addEventListener('click', undo);
    btnNew.addEventListener('click', newMatch);
    btnExport.addEventListener('click',()=>{navigator.clipboard.writeText(btoa(JSON.stringify(S))); alert('State copied.');});
    btnImport.addEventListener('click',()=>{const t=prompt('Paste state:'); if(!t) return; try{S=JSON.parse(atob(t)); render(); log('Imported.');}catch(e){alert('Invalid state')}});

    // ========= PeerJS: Room Key connect =========
    let peer=null, conn=null;
    function setRTC(s){ rtcState.textContent=s }
    function makePeer(id){ return new Peer(id, { host:'0.peerjs.com', port:443, path:'/', secure:true }); }
    function onConn(c){ conn=c; setRTC('Connected'); conn.on('data', msg=>{ if(msg.type==='SYNC'){ S=msg.state; render(); } if(msg.type==='LOG'){ log(msg.text) } }); sync(true); }
    function sync(force){ if(conn && conn.open){ conn.send({type:'SYNC', state:S}); } }

    btnHost.addEventListener('click',()=>{
      const key=(roomKeyEl.value||'room-'+Math.random().toString(36).slice(2,8)).toLowerCase();
      roomKeyEl.value=key; const share=location.origin+location.pathname+'?key='+encodeURIComponent(key);
      shareLinkEl.value=share; navigator.clipboard.writeText(share).catch(()=>{});
      peer=makePeer(key); setRTC('Hosting…');
      peer.on('open',()=>setRTC('Waiting for guest. Share link above.'));
      peer.on('connection', onConn);
    });

    btnJoin.addEventListener('click',()=>{
      const key=(roomKeyEl.value||new URLSearchParams(location.search).get('key')||'').toLowerCase();
      if(!key) return alert('Enter Room Key');
      peer=makePeer(undefined); setRTC('Connecting…');
      peer.on('open',()=>{ const c=peer.connect(key); c.on('open',()=>onConn(c)); c.on('error',()=>alert('Connect error')); });
    });

    window.addEventListener('load',()=>{ const k=new URLSearchParams(location.search).get('key'); if(k){ roomKeyEl.value=k; btnJoin.click(); } });

    render();
  })();
  </script>
</body>
</html>
