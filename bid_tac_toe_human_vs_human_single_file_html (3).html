<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bid Tac Toe — Human vs Human</title>
  <style>
    :root{
      --bg:#0a0b12; --panel:#0d1322; --panel2:#0b0f1d; --text:#eaf2ff; --muted:#9fb3d1; --bd:#1c2541;
      --neon-blue:#66e3ff; --neon-pink:#ff5fd1; --neon-yellow:#ffd166; --accent:#64d0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(102,227,255,.18), transparent 60%),
        radial-gradient(1200px 700px at 85% 110%, rgba(255,95,209,.15), transparent 60%),
        linear-gradient(180deg, #070910, #0a0b12);
      overflow-y:auto;
    }
    .wrap{max-width:1220px; margin:28px auto; padding:0 18px}
    h1{margin:.2rem 0 .4rem; font-size:30px; letter-spacing:.4px}
    .sub{color:var(--muted); font-size:14px}

    /* neon divider */
    .layout{display:grid; grid-template-columns: 1fr 430px; gap:18px; align-items:start}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--bd); border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #27304d; background:#0b1324; font-size:12px; color:#b9d6ff}

    /* Board */
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px; width:min(560px,100%); margin:10px 0}
    .cell{aspect-ratio:1/1; border:1px solid #27304d; border-radius:18px; background:#0b1324;
      display:flex; align-items:center; justify-content:center; font-weight:900; font-size:60px; user-select:none;
      transition:transform .08s ease, box-shadow .12s ease, background .15s ease}
    .cell.empty{color:#5b6c8d}
    .cell.x{color:var(--neon-blue); text-shadow:0 0 16px rgba(102,227,255,.7), 0 2px 0 rgba(0,0,0,.35)}
    .cell.o{color:var(--neon-pink); text-shadow:0 0 16px rgba(255,95,209,.7), 0 2px 0 rgba(0,0,0,.35)}
    .cell.disabled{opacity:.85; cursor:not-allowed}
    .cell.placeable{cursor:pointer; box-shadow:0 0 0 2px rgba(102,227,255,.5), 0 0 24px rgba(102,227,255,.35), inset 0 0 30px rgba(102,227,255,.08)}
    .cell.placeable:hover{transform:translateY(-2px)}

    /* Right column */
    .right .section{margin-bottom:16px}
    .right .section:last-child{margin-bottom:0}

    .muted{color:var(--muted)}
    .btn{background:linear-gradient(180deg, #3ddcff, #1ab6f2); border:none; color:#08121f; font-weight:800; padding:10px 14px; border-radius:12px; cursor:pointer}
    .btn.secondary{background:linear-gradient(180deg,#ff83da,#d44bb1); color:#0c0f18}
    .btn.warn{background:linear-gradient(180deg,#ffd166,#ffb627)}
    .btn.ghost{background:transparent; border:1px solid #2a3458; color:#cfe5ff}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .field{display:flex; gap:10px; align-items:center}
    input, textarea, select{background:#0c152b; border:1px solid #243257; color:#eaf2ff; border-radius:12px; padding:10px 12px; width:100%}
    .log{font-family:ui-monospace,Menlo,Consolas,monospace; background:#0c152b; border:1px solid #243257; border-radius:12px; padding:10px; height:150px; overflow:auto}

    /* Winner Modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; backdrop-filter:blur(6px)}
    .modal.show{display:flex}
    .modal::before{content:""; position:absolute; inset:0; background:
      radial-gradient(800px 400px at 30% 20%, rgba(102,227,255,.18), transparent 60%),
      radial-gradient(800px 400px at 70% 80%, rgba(255,95,209,.15), transparent 60%),
      rgba(5,8,15,.7)}
    .card{position:relative; background:linear-gradient(180deg,#0f1833,#0b1227); border:1px solid #2a3a6e; border-radius:20px; padding:26px; width:min(520px,90vw); text-align:center;
      box-shadow:0 0 40px rgba(102,227,255,.35), 0 0 40px rgba(255,95,209,.25) inset}
    .winTitle{font-size:28px; margin:0 0 8px; letter-spacing:.6px}
    .winReason{color:#b9d6ff; margin-bottom:16px}
    .btnRow{display:flex; gap:10px; justify-content:center}

    /* glow header underline */
    h1::after{content:""; display:block; width:120px; height:3px; margin-top:8px; border-radius:999px; background:linear-gradient(90deg,var(--neon-blue), var(--neon-pink))}
  </style>
  <script defer src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Bid Tac Toe — Human vs Human</h1>
    <div class="sub">Cyber‑neon auction Tic‑Tac‑Toe. Step 1: both secretly bid. Step 2: higher bid winner clicks a cell to place. <b>Both</b> pay their bid. Ties decide by coin toss.</div>

    <div class="layout">
      <!-- LEFT: Board -->
      <div class="panel">
        <div class="badge">Board</div>
        <div id="board" class="grid" aria-label="board"></div>
        <div id="status" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- RIGHT: Controls + Rules (rules at bottom) -->
      <div class="right">
        <div class="panel section">
          <div class="badge">Online（輸入相同 Key 即可連）</div>
          <div class="field" style="margin-top:10px"><label style="width:120px">Room Key</label><input id="roomKey" placeholder="SUNNY88"/></div>
          <div class="field"><label style="width:120px">Share Link</label><input id="shareLink" readonly placeholder="建立後自動產生"/></div>
          <div style="display:flex; gap:10px; margin-top:8px"><button id="btnHost" class="btn">Host</button><button id="btnJoin" class="btn secondary">Join</button></div>
          <div id="rtcState" class="muted" style="margin-top:6px">Offline</div>
        </div>

        <div class="panel section">
          <div class="badge">Bidding</div>
          <div class="field" style="margin-top:10px"><label style="width:120px">Player X bid</label><input id="bidX" type="number" min="0" step="0.01" placeholder="0"/></div>
          <div class="field"><label style="width:120px">Player O bid</label><input id="bidO" type="number" min="0" step="0.01" placeholder="0"/></div>
          <div style="display:flex; gap:10px; margin-top:8px"><button id="btnLockBids" class="btn">Lock & Reveal</button><button id="btnUndo" class="btn ghost">Undo</button></div>
          <div class="muted" id="hint" style="margin-top:6px">Enter bids then click Lock & Reveal.</div>
        </div>

        <div class="panel section">
          <div class="badge">Match</div>
          <div style="display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap; margin-top:10px">
            <div style="flex:1 1 160px">
              <div>Player <b>X</b> budget: $<span id="moneyX">100</span></div>
              <div>Player <b>O</b> budget: $<span id="moneyO">100</span></div>
            </div>
            <div style="flex:1 1 220px">
              <div class="field"><label style="width:120px">Start Budget</label><input id="startBudget" type="number" value="100" min="1"/></div>
              <div class="field"><label style="width:120px">First Player</label><select id="firstPlayer"><option>X</option><option>O</option></select></div>
              <div style="display:flex; gap:10px; margin-top:8px"><button id="btnNew" class="btn warn">New Match</button><button id="btnExport" class="btn ghost">Export</button><button id="btnImport" class="btn ghost">Import</button></div>
            </div>
          </div>
          <div style="margin-top:10px"><div class="badge">Event Log</div><div id="log" class="log"></div></div>
        </div>

        <div class="panel section">
          <div class="badge">Rules</div>
          <ol>
            <li><b>Standard Win</b>: First to make 3‑in‑a‑row wins.</li>
            <li><b>Economic Win</b>: If the board fills with no 3‑in‑a‑row, the player with <u>more money</u> wins (tie → draw).</li>
            <li><b>Bankruptcy</b>: If your opponent’s budget hits <b>$0</b>, you win immediately.</li>
            <li>Round flow: both submit bids → <b>Lock & Reveal</b> → winner <u>clicks a cell</u> to place. <b>Both</b> pay their bids.</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Winner Modal -->
  <div id="winModal" class="modal" aria-modal="true" role="dialog">
    <div class="card">
      <div id="winTitle" class="winTitle">Winner</div>
      <div id="winReason" class="winReason">Reason</div>
      <div class="btnRow">
        <button id="btnPlayAgain" class="btn warn">Play Again</button>
        <button id="btnCloseModal" class="btn ghost">Close</button>
      </div>
    </div>
  </div>

  <script>
  ;(()=>{
    const $ = s=>document.querySelector(s);
    const boardEl = $('#board');
    const statusEl = $('#status');
    const logEl = $('#log');
    const hintEl = $('#hint');
    const moneyXEl = $('#moneyX');
    const moneyOEl = $('#moneyO');
    const bidXEl = $('#bidX');
    const bidOEl = $('#bidO');

    const btnLock=$('#btnLockBids');
    const btnUndo=$('#btnUndo');
    const btnNew=$('#btnNew');
    const startBudgetEl=$('#startBudget');
    const firstPlayerEl=$('#firstPlayer');
    const btnExport=$('#btnExport');
    const btnImport=$('#btnImport');

    const roomKeyEl=$('#roomKey');
    const shareLinkEl=$('#shareLink');
    const btnHost=$('#btnHost');
    const btnJoin=$('#btnJoin');
    const rtcState=$('#rtcState');

    // modal
    const modal=$('#winModal');
    const winTitle=$('#winTitle');
    const winReason=$('#winReason');
    const btnPlayAgain=$('#btnPlayAgain');
    const btnCloseModal=$('#btnCloseModal');

    let S = { board:Array(9).fill(''), turn:'X', money:{X:100,O:100}, history:[], finished:false, pending:null };

    function render(){
      boardEl.innerHTML='';
      S.board.forEach((v,i)=>{
        const d=document.createElement('div');
        const placeable = !v && !S.finished && !!S.pending; // winner is choosing a cell
        d.className='cell'+(v?' '+(v==='X'?'x':'o'):' empty')+(S.finished?' disabled':'')+(placeable?' placeable':'');
        d.textContent=v||i;
        d.addEventListener('click',()=>{
          if(placeable){
            // placement step
            S.board[i] = S.pending.winner;
            S.history.push({bx:S.pending.bx, bo:S.pending.bo, winner:S.pending.winner, cell:i, turn:S.turn});
            decideAfterPlacement();
            S.pending=null; bidXEl.disabled=false; bidOEl.disabled=false; btnLock.disabled=false; hintEl.textContent='Enter bids then click Lock & Reveal.';
            render();
          }
        });
        boardEl.appendChild(d);
      });
      moneyXEl.textContent=S.money.X.toFixed(2);
      moneyOEl.textContent=S.money.O.toFixed(2);
      statusEl.textContent=S.finished? 'Match finished' : (S.pending? `Winner: ${S.pending.winner} — click a cell to place` : `Turn: ${S.turn}`);
      sync();
    }

    function log(m){ const t=new Date().toLocaleTimeString(); logEl.insertAdjacentHTML('beforeend',`[${t}] ${m}<br/>`); logEl.scrollTop=logEl.scrollHeight; }
    function lines(){return [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]}
    function checkWin(){ for(const [a,b,c] of lines()) if(S.board[a]&&S.board[a]===S.board[b]&&S.board[a]===S.board[c]) return S.board[a]; if(S.board.every(x=>x)) return 'F'; return '' }
    const toss=()=>Math.random()<.5?'X':'O';

    function showWin(winner, reason){
      winTitle.textContent = `${winner} WINS!`;
      winTitle.style.color = winner==='X'? 'var(--neon-blue)' : 'var(--neon-pink)';
      winReason.textContent = reason;
      modal.classList.add('show');
    }

    function hideWin(){ modal.classList.remove('show'); }

    function decideAfterPlacement(){
      const w=checkWin();
      if(w==='X'||w==='O'){ S.finished=true; log(`<b>${w}</b> wins!`); showWin(w, 'Standard Win (3‑in‑a‑row)'); return; }
      if(w==='F'){
        if(S.money.X>S.money.O){ S.finished=true; log('<b>X</b> wins by Economic Win'); showWin('X','Economic Win (more money)'); }
        else if(S.money.O>S.money.X){ S.finished=true; log('<b>O</b> wins by Economic Win'); showWin('O','Economic Win (more money)'); }
        else { S.finished=true; log('Draw'); showWin('No one','Draw'); }
        return;
      }
      // Bankruptcy check after placement
      if(S.money.X<=0 && S.money.O<=0){ S.finished=true; log('Draw (both bankrupt)'); showWin('No one','Draw — both bankrupt'); return; }
      if(S.money.X<=0){ S.finished=true; log('<b>O</b> wins by Bankruptcy'); showWin('O','Bankruptcy'); return; }
      if(S.money.O<=0){ S.finished=true; log('<b>X</b> wins by Bankruptcy'); showWin('X','Bankruptcy'); return; }
      // continue
      S.turn = (S.turn==='X'?'O':'X');
    }

    function lockReveal(){
      if(S.finished) return;
      if(S.pending) return alert('Place your mark first.');
      // pre bankruptcy check
      if(S.money.X<=0 && S.money.O<=0){ S.finished=true; render(); return log('Draw (both bankrupt).'); }
      if(S.money.X<=0){ S.finished=true; render(); showWin('O','Bankruptcy'); return log('<b>O</b> wins by Bankruptcy.'); }
      if(S.money.O<=0){ S.finished=true; render(); showWin('X','Bankruptcy'); return log('<b>X</b> wins by Bankruptcy.'); }

      const bx=parseFloat(bidXEl.value||'0');
      const bo=parseFloat(bidOEl.value||'0');
      if([bx,bo].some(x=>isNaN(x)||x<0)) return alert('Bids must be non‑negative');
      if(bx>S.money.X||bo>S.money.O) return alert('Bid exceeds budget');
      const winner = bx>bo? 'X' : bo>bx? 'O' : toss();
      S.money.X-=bx; S.money.O-=bo;
      S.pending = {winner, bx, bo};
      log(`Reveal — X:$${bx.toFixed(2)} O:$${bo.toFixed(2)} ⇒ <b>${winner}</b> to place`);
      bidXEl.disabled=true; bidOEl.disabled=true; btnLock.disabled=true; hintEl.textContent=`${winner} is choosing a cell…`;
      bidXEl.value=''; bidOEl.value='';
      render();
    }

    function undo(){
      if(S.pending){ S.money.X+=S.pending.bx; S.money.O+=S.pending.bo; log('Undo reveal — bids refunded.'); S.pending=null; bidXEl.disabled=false; bidOEl.disabled=false; btnLock.disabled=false; hintEl.textContent='Enter bids then click Lock & Reveal.'; render(); return; }
      const r=S.history.pop(); if(!r) return; S.board[r.cell]=''; S.money.X+=r.bx; S.money.O+=r.bo; S.turn=r.turn; S.finished=false; hideWin(); render(); log('Undo last turn.');
    }

    function newMatch(){ const b=Math.max(1,parseFloat(startBudgetEl.value||'100')); S={board:Array(9).fill(''),turn:firstPlayerEl.value,money:{X:b,O:b},history:[],finished:false,pending:null}; hideWin(); render(); log('— New match —'); }

    // controls
    document.getElementById('btnPlayAgain').addEventListener('click', ()=>{ newMatch(); });
    document.getElementById('btnCloseModal').addEventListener('click', ()=> hideWin());

    btnLock.addEventListener('click', lockReveal);
    btnUndo.addEventListener('click', undo);
    btnNew.addEventListener('click', newMatch);
    btnExport.addEventListener('click',()=>{navigator.clipboard.writeText(btoa(JSON.stringify(S))); alert('State copied.');});
    btnImport.addEventListener('click',()=>{const t=prompt('Paste state:'); if(!t) return; try{S=JSON.parse(atob(t)); render(); log('Imported.');}catch(e){alert('Invalid state')}});

    // ========= PeerJS: Room Key connect =========
    let peer=null, conn=null;
    function setRTC(s){ rtcState.textContent=s }
    function makePeer(id){ return new Peer(id, { host:'0.peerjs.com', port:443, path:'/', secure:true }); }
    function onConn(c){ conn=c; setRTC('Connected'); conn.on('data', msg=>{ if(msg.type==='SYNC'){ S=msg.state; render(); } if(msg.type==='LOG'){ log(msg.text) } }); sync(true); }
    function sync(force){ if(conn && conn.open){ conn.send({type:'SYNC', state:S}); } }

    btnHost.addEventListener('click',()=>{
      const key=(roomKeyEl.value||'room-'+Math.random().toString(36).slice(2,8)).toLowerCase();
      roomKeyEl.value=key; const share=location.origin+location.pathname+'?key='+encodeURIComponent(key);
      shareLinkEl.value=share; navigator.clipboard.writeText(share).catch(()=>{});
      peer=makePeer(key); setRTC('Hosting…');
      peer.on('open',()=>setRTC('Waiting for guest. Share link above.'));
      peer.on('connection', onConn);
    });

    btnJoin.addEventListener('click',()=>{
      const key=(roomKeyEl.value||new URLSearchParams(location.search).get('key')||'').toLowerCase();
      if(!key) return alert('Enter Room Key');
      peer=makePeer(undefined); setRTC('Connecting…');
      peer.on('open',()=>{ const c=peer.connect(key); c.on('open',()=>onConn(c)); c.on('error',()=>alert('Connect error')); });
    });

    window.addEventListener('load',()=>{ const k=new URLSearchParams(location.search).get('key'); if(k){ roomKeyEl.value=k; btnJoin.click(); } });

    render();
  })();
  </script>
</body>
</html>