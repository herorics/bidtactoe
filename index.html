<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Long Run Will … v9.9.6</title>
<style>
  :root{--bg:#0a0b12;--panel:#0f1426;--panel2:#0b1020;--text:#eaf2ff;--muted:#9fb3d1;--bd:#1f2a4a;--blue:#66e3ff;--pink:#ff5fd1;--yellow:#ffd166;--green:#2ee6a6}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
    background:radial-gradient(1100px 620px at 12% -10%,rgba(102,227,255,.18),transparent 60%),radial-gradient(1100px 620px at 88% 110%,rgba(255,95,209,.15),transparent 60%),linear-gradient(180deg,#070910,#090a12);
    display:flex;align-items:flex-start;justify-content:center;padding:10px;font-size:12px}
  .wrap{width:min(1080px,96%)}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:6px;flex-wrap:wrap}
  .title{font-size:22px;font-weight:900;letter-spacing:.6px;text-shadow:0 0 14px rgba(102,227,255,.45)}.title span{color:var(--blue)}
  .btn{background:linear-gradient(180deg,#3ddcff,#1ab6f2);border:none;color:#08121f;font-weight:800;padding:5px 8px;border-radius:8px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.3);font-size:12px}
  .btn.warn{background:linear-gradient(180deg,#ffd166,#ffb627)}.btn.ghost{background:transparent;border:1px solid #2a3458;color:#cfe5ff}.btn:disabled{opacity:.6;cursor:not-allowed}
  .cols{display:grid;grid-template-columns:240px 1fr 240px;gap:10px}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--bd);border-radius:12px;padding:6px;box-shadow:0 8px 22px rgba(0,0,0,.35);font-size:12px}
  .player{position:relative}.badgeCorner{position:absolute;top:6px;right:6px;border-radius:8px;border:1px solid #2a3660;background:#0b1630;padding:2px 6px;font-size:10px;font-weight:900}
  .badgeCorner.x{color:var(--blue)}.badgeCorner.o{color:var(--pink)}.pname{font-weight:900;font-size:14px;margin:2px 0 4px}
  .meter{height:8px;background:#0c152b;border:1px solid #243257;border-radius:999px;overflow:hidden;margin:4px 0}.meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--blue),var(--pink));width:100%}
  .bigAmount{font-size:18px;font-weight:900}.lastBid{margin-top:4px;border:1px solid #22335c;border-radius:8px;padding:5px 6px;background:#0a142d;color:#bfe3ff;font-size:11px}
  .chat{margin-top:6px;border:1px solid #22335c;border-radius:8px;background:#0a142d;display:flex;flex-direction:column;height:110px}
  .chatLog{flex:1 1 auto;overflow:auto;padding:5px 6px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:11px}.chatRow{margin:2px 0}.chatMine{color:#a5ffd6}.chatOther{color:#ffb1ea}
  .chatInput{display:flex;gap:6px;padding:5px;border-top:1px solid #22335c}.chatInput input{flex:1 1 auto;background:#0c152b;border:1px solid #243257;color:#eaf2ff;border-radius:8px;padding:5px 6px;font-size:12px}
  .boardWrap{display:flex;flex-direction:column;align-items:center;gap:6px}
  .banner{font-size:14px;text-align:center}
  .grid{display:grid;grid-template-columns:repeat(3,90px);gap:8px;padding:6px;border-radius:12px;background:linear-gradient(180deg,#0b1227,#0a152e);border:1px solid #23335b}
  .cell{width:90px;height:90px;border:1px solid #263255;border-radius:10px;background:#0b1326;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:36px;user-select:none;transition:transform .08s ease,box-shadow .12s ease}
  .cell.empty{color:#5b6c8d}.cell.x{color:var(--blue);text-shadow:0 0 14px rgba(102,227,255,.7),0 2px 0 rgba(0,0,0,.35)}.cell.o{color:var(--pink);text-shadow:0 0 14px rgba(255,95,209,.7),0 2px 0 rgba(0,0,0,.35)}
  .cell.placeable{cursor:pointer;box-shadow:0 0 0 2px rgba(102,227,255,.55),0 0 20px rgba(102,227,255,.35),inset 0 0 24px rgba(102,227,255,.08)}.cell.placeable:hover{transform:translateY(-2px)}
  .centerControls{display:flex;gap:8px;align-items:center;margin-top:4px}.status{color:#cfe5ff;font-size:12px}

  .under{margin-top:8px;width:100%;max-width:460px;background:linear-gradient(180deg,#0f1833,#0b1227);border:1px solid #2a3a6e;border-radius:12px;padding:8px;box-shadow:0 8px 22px rgba(0,0,0,.35)}
  .under h3{margin:0 0 4px;font-size:14px}
  .underRow{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .under input{flex:1 1 140px;background:#0c152b;border:1px solid #243257;color:#eaf2ff;border-radius:8px;padding:6px 7px;font-size:12px}
  .pill{display:inline-block;padding:3px 7px;border-radius:999px;background:#12b4ff20;border:1px solid #1f5a88;color:#bfe3ff;font-weight:800;font-size:11px}

  .toast{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#0f1833;border:1px solid #2a3a6e;color:#dff1ff;padding:6px 10px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:none;z-index:90;font-size:12px}
  .toast.show{display:block}.toast.good{border-color:#1e775c;color:#b9ffd6}.toast.bad{border-color:#7d2334;color:#ffd1d1}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:80;backdrop-filter:blur(5px)}
  .modal.show{display:flex}
  .modal::before{content:"";position:absolute;inset:0;background:radial-gradient(700px 360px at 30% 20%,rgba(102,227,255,.18),transparent 60%),radial-gradient(700px 360px at 70% 80%,rgba(255,95,209,.15),transparent 60%),rgba(5,8,15,.7);pointer-events:none}
  .card{position:relative;background:linear-gradient(180deg,#0f1833,#0b1227);border:1px solid #2a3a6e;border-radius:14px;padding:14px 12px;width:min(460px,92vw);text-align:center;box-shadow:0 0 36px rgba(102,227,255,.35),0 0 36px rgba(255,95,209,.25) inset}
  .card::after{content:"";position:absolute;inset:0;border-radius:14px;padding:2px;background:linear-gradient(135deg,var(--blue),var(--pink));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
  .winTitle{font-size:18px;margin:0 0 6px;letter-spacing:.4px}.winReason{color:#b9d6ff;margin-bottom:10px;font-size:12px}

  .scoreBox{margin-top:6px;padding:8px 10px;border:1px solid #2a3a6e;border-radius:12px;background:#0b142b;
    font-weight:900;font-size:18px;letter-spacing:.4px;text-align:left;box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .rules{margin-top:6px;padding:8px 10px;border:1px solid #203059;border-radius:12px;background:#0b142b;font-size:11px;line-height:1.55}
  .rules h4{margin:0 0 4px;font-size:12px}
  .rtcLine small{color:#8aa3c9}

  /* Mobile layout */
  @media (max-width: 680px){
    .wrap{width:100%}
    .cols{grid-template-columns:1fr;gap:8px}
    .boardWrap{order:0}
    .panel{order:1}
    .grid{grid-template-columns:repeat(3, 28vw); gap:3vw; padding:3vw}
    .cell{width:28vw;height:28vw;font-size:12vw;border-radius:4vw}
    .under{max-width:92vw}
    .header .right input{width:58vw}
  }
</style>
<script defer src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title"><span>Long</span> Run Will …</div>
      <div class="right" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <button id="btnCreateLink" class="btn">Create Share Link</button>
        <input id="shareLink" style="width:300px;background:#0c152b;border:1px solid #243257;color:#eaf2ff;border-radius:8px;padding:6px 8px" readonly placeholder="Create a link and send to your friend"/>
      </div>
    </div>

    <div class="cols">
      <!-- Left player (X) -->
      <div class="panel player">
        <div class="badgeCorner x">X</div>
        <div class="pname" id="nameX">X: —</div>
        <div class="meter"><span id="mx"></span></div>
        <div class="bigAmount">$ <span id="moneyX">100</span></div>
        <div class="lastBid">Last bid: $ <span id="lastX">0</span></div>
        <div class="chat">
          <div id="chatLog" class="chatLog"></div>
          <div class="chatInput">
            <input id="chatText" placeholder="Type a message…" />
            <button id="chatSend" class="btn">Send</button>
          </div>
        </div>
      </div>

      <!-- Center board -->
      <div class="boardWrap">
        <div id="banner" class="banner">Not connected</div>
        <div id="board" class="grid" aria-label="board"></div>
        <div class="centerControls">
          <div class="status" id="status"></div>
        </div>

        <!-- under-board controls -->
        <div id="under" class="under">
          <h3>Enter your bid</h3>
          <div class="underRow" id="underBidRow">
            <input id="bidInput2" type="number" min="0" step="0.01" placeholder="0" />
            <button id="btnSubmitBid2" class="btn">Confirm bid</button>
            <span id="bidWaiting2" class="pill" style="display:none">Waiting for opponent…</span>
          </div>
          <div class="underRow" style="margin-top:6px">
            <div id="roundBody2" class="pill" style="display:none"></div>
            <button id="btnNextMatchUnder" class="btn warn" style="margin-left:auto" disabled>Start Next Match</button>
          </div>
        </div>
      </div>

      <!-- Right player (O) -->
      <div class="panel player">
        <div class="badgeCorner o">O</div>
        <div class="pname" id="nameO">O: —</div>
        <div class="meter"><span id="mo"></span></div>
        <div class="bigAmount">$ <span id="moneyO">100</span></div>
        <div class="lastBid">Last bid: $ <span id="lastO">0</span></div>
        <div class="rtcLine" style="margin-top:8px;color:#9fb3d1">RTC: <span id="rtc">Offline</span> <small id="rtcDbg"></small></div>
        <div id="scoreBox" class="scoreBox">Score — <span id="sHost">0</span> : <span id="sGuest">0</span></div>
        <div class="rules">
          <h4>Game Rules</h4>
          <ul>
            <li>Start with $100 each.</li>
            <li>Both secretly bid. Higher bid wins the right to mark; <b>both bids are paid</b>.</li>
            <li>Tie → coin toss.</li>
            <li>Win: 3‑in‑a‑row, more money when board full, or opponent bankruptcy.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- toast -->
  <div id="toast" class="toast">Connected</div>

  <!-- Round Winner modal -->
  <div id="roundModal" class="modal" aria-modal="true" role="dialog">
    <div class="card">
      <div id="roundTitle" class="winTitle">Round Result</div>
      <div id="roundReason" class="winReason"></div>
      <div class="underRow" style="justify-content:center">
        <button id="roundOk" class="btn">OK</button>
      </div>
    </div>
  </div>

  <!-- Match Winner modal -->
  <div id="winModal" class="modal" aria-modal="true" role="dialog">
    <div class="card">
      <div id="winTitle" class="winTitle">Winner</div>
      <div id="winReason" class="winReason">Reason</div>
      <div style="margin:6px 0" class="winReason">Overall Score — <b id="sumScore">0 : 0</b></div>
      <div class="underRow" style="justify-content:center">
        <button id="btnNextMatch2" class="btn warn">Start Next Match</button>
        <button id="btnCloseWin" class="btn ghost">Close</button>
      </div>
    </div>
  </div>

<script>
;(()=>{
  const $ = s=>document.querySelector(s);
  const boardEl=$('#board'), statusEl=$('#status'), banner=$('#banner'), toast=$('#toast');
  const moneyXEl=$('#moneyX'), moneyOEl=$('#moneyO'), mxEl=$('#mx'), moEl=$('#mo');
  const lastX=$('#lastX'), lastO=$('#lastO');
  const btnCreateLink=$('#btnCreateLink'), shareLinkEl=$('#shareLink'), rtcEl=$('#rtc'), rtcDbg=$('#rtcDbg');
  const btnNextMatchUnder=$('#btnNextMatchUnder');
  const bidInput2=$('#bidInput2'), btnSubmitBid2=$('#btnSubmitBid2'), bidWaiting2=$('#bidWaiting2'), roundBody2=$('#roundBody2');
  const roundModal=$('#roundModal'), roundTitle=$('#roundTitle'), roundReason=$('#roundReason'), roundOk=$('#roundOk');
  const winModal=$('#winModal'), winTitle=$('#winTitle'), winReason=$('#winReason'), btnNextMatch2=$('#btnNextMatch2'), btnCloseWin=$('#btnCloseWin'), sumScore=$('#sumScore');

  const nameX=$('#nameX'), nameO=$('#nameO'), sHost=$('#sHost'), sGuest=$('#sGuest');
  const chatLog=$('#chatLog'), chatText=$('#chatText'), chatSend=$('#chatSend');

  const lines=()=>[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  function checkWin(board){ for(const [a,b,c] of lines()) if(board[a]&&board[a]===board[b]&&board[a]===board[c]) return board[a]; if(board.every(x=>x)) return 'F'; return '' }

  let S = {
    board:Array(9).fill(''),
    money:{X:100,O:100},
    lastBid:{X:0,O:0},
    startBudget:100,
    matchNo:1,
    phase:'idle',
    pending:null,
    bids:{},
    lastWin:null,
    roundNo:0,
    lastRound:null,
    score:{host:{name:'',wins:0}, guest:{name:'',wins:0}}
  };
  let local = { role:'?', isHost:false, connected:false, myName:'', lastRoundSeen:0 };

  function toastMsg(msg, kind='good', ms=1600){ toast.textContent=msg; toast.className='toast show '+(kind==='bad'?'bad':'good'); setTimeout(()=>toast.className='toast', ms); }

  function updateNames(){
    nameX.textContent = 'X: ' + ((local.isHost? local.myName:S.score.host.name) || '—');
    nameO.textContent = 'O: ' + ((!local.isHost? local.myName:S.score.guest.name) || '—');
    sHost && (sHost.textContent = S.score.host.wins); sGuest && (sGuest.textContent = S.score.guest.wins);
  }
  function updateMeters(){
    moneyXEl.textContent=S.money.X.toFixed(0); moneyOEl.textContent=S.money.O.toFixed(0);
    lastX.textContent=S.lastBid.X.toFixed(0); lastO.textContent=S.lastBid.O.toFixed(0);
    mxEl.style.width=Math.max(0,Math.min(100,(S.money.X/S.startBudget)*100))+'%';
    moEl.style.width=Math.max(0,Math.min(100,(S.money.O/S.startBudget)*100))+'%';
  }
  function render(){
    boardEl.innerHTML='';
    S.board.forEach((v,i)=>{
      const canPlace = S.phase==='placing' && S.pending && !v && S.pending.winner===local.role;
      const d=document.createElement('div'); d.className='cell'+(v?' '+(v==='X'?'x':'o'):' empty')+(canPlace?' placeable':''); d.textContent=v||i;
      d.addEventListener('click',()=>{ if(canPlace){ if(local.isHost) hostPlace(i); else send({type:'PLACE', i}); } });
      boardEl.appendChild(d);
    });
    updateMeters(); updateNames();

    const canBid = local.connected && S.phase==='bidding' && typeof S.bids[local.role] !== 'number';
    bidInput2.disabled = !canBid; btnSubmitBid2.disabled = !canBid;
    bidWaiting2.style.display = (local.connected && S.phase==='bidding' && typeof S.bids[local.role] === 'number') ? 'inline-block' : 'none';
    if(S.lastRound && S.lastRound.roundNo && local.lastRoundSeen !== S.lastRound.roundNo){
      roundBody2.style.display='inline-block';
      roundBody2.textContent = `Round ${S.lastRound.roundNo}: X $${S.lastRound.bx.toFixed(0)} • O $${S.lastRound.bo.toFixed(0)} — ${S.lastRound.winner} wins & places.`;
      local.lastRoundSeen = S.lastRound.roundNo;
      bidWaiting2.style.display='none';

      roundTitle.textContent = `Round ${S.lastRound.roundNo} — ${S.lastRound.winner} wins`;
      roundReason.textContent = `X bid $${S.lastRound.bx.toFixed(0)} • O bid $${S.lastRound.bo.toFixed(0)}. ${S.lastRound.winner} may click a cell.`;
      roundModal.classList.add('show');
    }
    btnNextMatchUnder.disabled = !(local.connected && S.phase==='ended');
    statusEl.textContent = S.phase==='bidding' ? 'Bidding' : (S.phase==='placing' ? `${S.pending?S.pending.winner:''} to place` : (S.phase==='ended' ? 'Finished' : 'Not connected'));
    banner.textContent = local.connected ? ('Match #' + S.matchNo) : 'Not connected';
  }

  function closeRoundModal(){ roundModal.classList.remove('show'); }
  roundOk.addEventListener('click', closeRoundModal);

  // Host-only transitions
  function startMatchHost(resetMoney=false){
    if(!local.isHost) return;
    if(resetMoney) S.money={X:S.startBudget,O:S.startBudget};
    S.board=Array(9).fill(''); S.bids={}; S.pending=null; S.lastWin=null; S.phase='bidding'; S.lastBid={X:0,O:0};
    S.roundNo=0; S.lastRound=null;
    sendState(true); render();
  }
  function hostProcessBid(role, val){
    if(S.phase!=='bidding') return;
    const remain = role==='X'?S.money.X:S.money.O;
    S.bids[role]=Math.max(0, Math.min(remain, Number(val)||0));
    sendState(true);
    if(typeof S.bids.X==='number' && typeof S.bids.O==='number'){
      const bx=S.bids.X, bo=S.bids.O;
      S.money.X-=bx; S.money.O-=bo; S.lastBid.X=bx; S.lastBid.O=bo;
      const winner = bx>bo?'X':bo>bx?'O':(Math.random()<.5?'X':'O');
      S.pending = {winner,bx,bo}; S.phase='placing'; S.roundNo+=1; S.lastRound={bx,bo,winner,roundNo:S.roundNo};
      sendState(true); render();
    }
  }
  function concludeIfEnd(){
    const w=checkWin(S.board);
    if(w==='X'||w==='O'){
      S.phase='ended'; S.lastWin={winner:w, reason:'Standard Win (3-in-a-row)'};
      const side = (w==='X')?'host':'guest'; S.score[side].wins += 1;
    } else if(w==='F'){
      S.phase='ended';
      const reason=(S.money.X>S.money.O)?'Economic Win (more money)':
                    (S.money.O>S.money.X)?'Economic Win (more money)':'Draw';
      const winner=(S.money.X>S.money.O)?'X':(S.money.O>S.money.X)?'O':'No one';
      S.lastWin={winner,reason}; if(winner!=='No one'){ const side=(winner==='X')?'host':'guest'; S.score[side].wins += 1; }
    } else if(S.money.X<=0 || S.money.O<=0){
      const winner=S.money.X<=0 && S.money.O<=0?'No one':(S.money.X<=0?'O':'X');
      const reason=(winner==='No one')?'Draw — both bankrupt':'Bankruptcy';
      S.phase='ended'; S.lastWin={winner,reason}; if(winner!=='No one'){ const side=(winner==='X')?'host':'guest'; S.score[side].wins += 1; }
    } else return false;
    return true;
  }
  function hostPlace(i){
    if(S.phase!=='placing' || !S.pending || S.board[i]) return;
    S.board[i]=S.pending.winner;
    if(!concludeIfEnd()){ S.bids={}; S.pending=null; S.phase='bidding'; }
    sendState(true); render();
    if(S.phase==='ended'){ showWin(S.lastWin.winner, S.lastWin.reason); }
  }

  // Networking
  let peer=null, conn=null, syncTimer=null, syncTries=0;
  function setRTC(s){ rtcEl.textContent=s }
  function setDbg(s){ if(rtcDbg) rtcDbg.textContent=' '+s }

  function makePeer(id){
    const cfg = {
      host: 'peerjs.com',
      port: 443,
      path: '/myapp',
      secure: true,
      config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478?transport=udp' }] },
      debug: 1
    };
    return new Peer(id, cfg);
  }
  function send(obj){ if(conn && conn.open){ try{ conn.send(obj); }catch(e){} } }
  function sendState(burst=false){
    send({type:'STATE', S});
    if(burst){ // extra quick resends to defeat packet loss
      setTimeout(()=>send({type:'STATE', S}), 80);
      setTimeout(()=>send({type:'STATE', S}), 180);
    }
  }

  function bindConnection(c){
    conn=c;
    c.on('open', ()=>{
      local.connected=true; setRTC('Connected'); setDbg('(open)'); toastMsg('Connected ✅','good');
      // Start a short-lived sync pulse in case first packets are dropped
      if(syncTimer) clearInterval(syncTimer); syncTries=0;
      syncTimer=setInterval(()=>{ if(local.isHost){ sendState(); } if(++syncTries>30){ clearInterval(syncTimer); } }, 200);
      askName((name)=>{
        if(local.isHost){ local.myName=name; S.score.host.name=name; send({type:'NAME', who:'host', name}); startMatchHost(true); }
        else { local.myName=name; S.score.guest.name=name; send({type:'NAME', who:'guest', name}); send({type:'PING'}); }
        updateNames(); render();
      });
    });
    c.on('data', msg=>{
      if(msg.type==='PING'){ if(local.isHost) { sendState(true); } return; }
      if(msg.type==='STATE'){ S = msg.S; updateNames(); render(); return; }
      if(msg.type==='NAME'){ if(local.isHost){ S.score[msg.who].name = msg.name; sendState(); } updateNames(); return; }
      if(msg.type==='BID' && local.isHost){ hostProcessBid(msg.role, msg.value); return; }
      if(msg.type==='PLACE' && local.isHost){ hostPlace(msg.i); return; }
      if(msg.type==='NEXT' && local.isHost){ S.matchNo++; startMatchHost(true); return; }
      if(msg.type==='CHAT'){ addChat(msg.from, msg.text, false); return; }
    });
    c.on('close', ()=>{ local.connected=false; setRTC('Disconnected'); setDbg('(close)'); toastMsg('Disconnected ❌','bad',2200); });
    c.on('error', (e)=>{ setRTC('Error'); setDbg('(error)'); console.error(e); toastMsg('Connection error','bad',2200); });
  }

  // Chat
  function addChat(who, text, mine){
    const div=document.createElement('div'); div.className='chatRow ' + (mine?'chatMine':'chatOther');
    div.textContent = who+': '+text; chatLog.appendChild(div); chatLog.scrollTop=chatLog.scrollHeight;
  }
  chatSend.addEventListener('click', ()=>{
    const t = chatText.value.trim(); if(!t) return; chatText.value='';
    addChat(local.myName, t, true); send({type:'CHAT', from: local.myName, text:t});
  });
  chatText.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ chatSend.click(); }});

  // Under-panel actions
  function startNextMatch(){
    winModal.classList.remove('show');
    roundModal.classList.remove('show');
    if(local.isHost){ S.matchNo++; startMatchHost(true); } else { send({type:'NEXT'}); }
  }
  btnSubmitBid2.addEventListener('click', ()=>{
    const v=parseFloat(bidInput2.value||'0');
    const remain = local.role==='X'?S.money.X:S.money.O;
    if(isNaN(v) || v<0 || v>remain) return alert('Invalid bid');
    if(local.isHost) hostProcessBid(local.role, v); else send({type:'BID', role: local.role, value: v});
    bidInput2.value=''; bidWaiting2.style.display='inline-block';
  });
  btnNextMatchUnder.addEventListener('click', startNextMatch);
  btnNextMatch2.addEventListener('click', startNextMatch);
  btnCloseWin.addEventListener('click', ()=> winModal.classList.remove('show'));

  function showWin(winner, reason){
    winTitle.textContent=(winner==='No one')?'Draw':'🎉 Congrats! ' + winner + ' wins!';
    winTitle.style.color=(winner==='X')?'var(--blue)':((winner==='O')?'var(--pink)':'#cfe5ff');
    winReason.textContent=reason;
    sumScore.textContent = S.score.host.wins + ' : ' + S.score.guest.wins;
    winModal.classList.add('show');
    btnNextMatchUnder.disabled = false;
  }

  // Create/join
  function createShareLink(){
    const key='room-'+Math.random().toString(36).slice(2,8);
    const link=location.origin+location.pathname+'?key='+encodeURIComponent(key);
    shareLinkEl.value=link; navigator.clipboard.writeText(link).catch(()=>{});
    local.isHost=true; local.role='X';
    const p = makePeer(key);
    peer = p;
    setRTC('Hosting…'); setDbg('(new '+key+')');
    p.on('open', ()=> setRTC('Waiting for guest…'));
    p.on('connection', c=> bindConnection(c));
    p.on('error', e=>{ setDbg('(peer error)'); console.error(e); });
    render();
  }
  function joinFromKey(k){
    local.isHost=false; local.role='O';
    const p = makePeer();
    peer = p;
    setRTC('Connecting…'); setDbg('(join '+k+')');
    p.on('open', ()=>{ const c=peer.connect(k); bindConnection(c); });
    p.on('error', e=>{ setDbg('(peer error)'); console.error(e); });
    render();
  }

  function askName(cb){
    let name = '';
    while(!name){ name = prompt('Enter your display name:'); if(name===null){ name='Player'; break; } name = name.trim(); }
    cb(name);
  }

  btnCreateLink.addEventListener('click', createShareLink);
  window.addEventListener('load', ()=>{
    const k=new URLSearchParams(location.search).get('key');
    if(k){ joinFromKey(k); shareLinkEl.value = location.href; }
    render();
  });
})();
</script>
</body>
</html>
