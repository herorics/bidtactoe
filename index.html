<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Long Run Will ...</title>
<style>
  :root{--bg:#0a0b12;--panel:#0f1426;--panel2:#0b1020;--text:#eaf2ff;--muted:#9fb3d1;--bd:#1f2a4a;--blue:#66e3ff;--pink:#ff5fd1;--yellow:#ffd166;--green:#2ee6a6}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
    background:radial-gradient(1300px 760px at 12% -10%,rgba(102,227,255,.18),transparent 60%),radial-gradient(1300px 760px at 88% 110%,rgba(255,95,209,.15),transparent 60%),linear-gradient(180deg,#070910,#090a12);
    display:flex;align-items:flex-start;justify-content:center;padding:16px}
  .wrap{width:100%;max-width:1200px}
  .header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px}
  .title{font-size:clamp(22px,4.8vw,34px);font-weight:900;letter-spacing:.6px;text-shadow:0 0 18px rgba(102,227,255,.45)}.title span{color:var(--blue)}
  .score{font-weight:900;padding:6px 10px;border-radius:12px;border:1px solid #203059;background:#0b142b;color:#bfe3ff;font-size:clamp(14px,1.6vw,18px)}
  .btn{background:linear-gradient(180deg,#3ddcff,#1ab6f2);border:none;color:#08121f;font-weight:800;padding:8px 12px;border-radius:12px;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,.3);font-size:clamp(14px,1.4vw,16px)}
  .btn.warn{background:linear-gradient(180deg,#ffd166,#ffb627)}.btn.ghost{background:transparent;border:1px solid #2a3458;color:#cfe5ff}.btn:disabled{opacity:.6;cursor:not-allowed}
  .cols{display:grid;grid-template-columns:300px 1fr 300px;gap:16px}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--bd);border-radius:18px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .player{position:relative}.badgeCorner{position:absolute;top:10px;right:10px;border-radius:8px;border:1px solid #2a3660;background:#0b1630;padding:3px 7px;font-size:12px;font-weight:900}
  .badgeCorner.x{color:var(--blue)}.badgeCorner.o{color:var(--pink)}.pname{font-weight:900;font-size:clamp(16px,1.6vw,18px);margin:6px 0 8px}
  .meter{height:14px;background:#0c152b;border:1px solid #243257;border-radius:999px;overflow:hidden;margin:8px 0 6px}.meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--blue),var(--pink));width:100%}
  .bigAmount{font-size:clamp(18px,1.8vw,26px);font-weight:900}.lastBid{margin-top:8px;border:1px solid #22335c;border-radius:12px;padding:6px 8px;background:#0a142d;color:#bfe3ff;font-size:clamp(12px,1.2vw,14px)}
  .chat{margin-top:12px;border:1px solid #22335c;border-radius:12px;background:#0a142d;display:flex;flex-direction:column;height:180px}
  .chatLog{flex:1 1 auto;overflow:auto;padding:6px 8px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}.chatRow{margin:2px 0}.chatMine{color:#a5ffd6}.chatOther{color:#ffb1ea}
  .chatInput{display:flex;gap:6px;padding:6px;border-top:1px solid #22335c}.chatInput input{flex:1 1 auto;background:#0c152b;border:1px solid #243257;color:#eaf2ff;border-radius:10px;padding:6px 8px;font-size:14px}
  .boardWrap{display:flex;flex-direction:column;align-items:center;gap:10px}.banner{font-size:clamp(16px,1.8vw,22px);text-align:center}.winner{font-size:22px;font-weight:900;color:#b8ffe9}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(90px,1fr));gap:min(2vw,16px);width:100%;max-width:540px}
  .cell{aspect-ratio:1/1;border:1px solid #263255;border-radius:16px;background:#0b1326;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:clamp(28px,6vw,64px);user-select:none;transition:transform .08s ease,box-shadow .12s ease}
  .cell.empty{color:#7fa1d4}.cell.x{color:var(--blue);text-shadow:0 0 16px rgba(102,227,255,.7)}.cell.o{color:var(--pink);text-shadow:0 0 16px rgba(255,95,209,.7)}
  .cell.placeable{cursor:pointer;box-shadow:0 0 0 2px rgba(102,227,255,.55),0 0 24px rgba(102,227,255,.35),inset 0 0 30px rgba(102,227,255,.08)}.cell.placeable:hover{transform:translateY(-2px)}
  .centerControls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap;justify-content:center}.status{color:#cfe5ff;font-size:clamp(12px,1.2vw,14px)}
  .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#0f1833;border:1px solid #2a3a6e;color:#dff1ff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:none;z-index:90;font-size:clamp(12px,1.2vw,14px)}
  .toast.show{display:block}.toast.good{border-color:#1e775c;color:#b9ffd6}.toast.bad{border-color:#7d2334;color:#ffd1d1}
  #shareLink{width:340px}
  @media (max-width: 900px){
    .cols{grid-template-columns:1fr}
    .panel.player{margin-bottom:12px}
    #shareLink{width:100%}
    .grid{max-width:92vw}
  }
</style>
<script defer src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title"><span>Long</span> Run Will …</div>
      <div id="score" class="score">Score — <span id="sHost">0</span> : <span id="sGuest">0</span></div>
      <div class="right" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
        <button id="btnCreateLink" class="btn">Create Share Link</button>
        <input id="shareLink" readonly placeholder="Create a link and send to your friend"
               style="background:#0c152b;border:1px solid #243257;color:#eaf2ff;border-radius:10px;padding:8px 10px"/>
      </div>
    </div>

    <div class="cols">
      <!-- Left: X -->
      <div class="panel player">
        <div class="badgeCorner x">X</div>
        <div class="pname" id="nameX">X: —</div>
        <div class="meter"><span id="mx"></span></div>
        <div class="bigAmount">$ <span id="moneyX">100</span></div>
        <div class="lastBid">Last bid: $ <span id="lastX">0</span></div>
        <div class="chat">
          <div id="chatLog" class="chatLog"></div>
          <div class="chatInput">
            <input id="chatText" placeholder="Type a message…" />
            <button id="chatSend" class="btn">Send</button>
          </div>
        </div>
      </div>

      <!-- Center: board -->
      <div class="boardWrap">
        <div id="banner" class="banner">Not connected</div>
        <div id="board" class="grid" aria-label="board"></div>
        <div class="centerControls">
          <button id="btnBid" class="btn">Bid for Next Round</button>
          <div class="status" id="status"></div>
        </div>
        <div class="centerControls">
          <button id="btnNextMatch" class="btn warn" disabled>Start Next Match</button>
        </div>
      </div>

      <!-- Right: O -->
      <div class="panel player">
        <div class="badgeCorner o">O</div>
        <div class="pname" id="nameO">O: —</div>
        <div class="meter"><span id="mo"></span></div>
        <div class="bigAmount">$ <span id="moneyO">100</span></div>
        <div class="lastBid">Last bid: $ <span id="lastO">0</span></div>
        <div style="margin-top:12px;color:#9fb3d1">RTC: <span id="rtc">Offline</span></div>
      </div>
    </div>
  </div>

  <!-- toasts -->
  <div id="toast" class="toast">Connected</div>

  <!-- Bid Modal -->
  <div id="bidModal" class="modal" aria-modal="true" role="dialog">
    <div class="card">
      <h2 id="bidTitle" class="winTitle">Enter your bid</h2>
      <div id="bidHint" class="winReason">Submit and wait for your opponent. Amounts stay hidden.</div>
      <div class="row" style="justify-content:center; gap:10px; margin:10px 0">
        <input id="bidInput" type="number" min="0" step="0.01" placeholder="0" />
        <button id="btnSubmitBid" class="btn">Confirm bid</button>
      </div>
      <div id="bidWaiting" class="winReason" style="display:none">Waiting for opponent…</div>
    </div>
  </div>

  <!-- Round Result Modal -->
  <div id="roundModal" class="modal" aria-modal="true" role="dialog">
    <div class="card">
      <div id="roundTitle" class="winTitle">Round result</div>
      <div id="roundBody" class="winReason"></div>
      <div class="row" style="justify-content:center; gap:8px">
        <button id="roundOk" class="btn">OK</button>
      </div>
    </div>
  </div>

  <!-- Match Win Modal -->
  <div id="winModal" class="modal" aria-modal="true" role="dialog">
    <div class="card">
      <div id="winTitle" class="winTitle">Winner</div>
      <div id="winReason" class="winReason">Reason</div>
      <div style="margin:10px 0" class="winReason">Overall Score — <b id="sumScore">0 : 0</b></div>
      <div class="row" style="justify-content:center; gap:8px">
        <button id="btnNextMatch2" class="btn warn">Start Next Match</button>
        <button id="btnCloseWin" class="btn ghost">Close</button>
      </div>
    </div>
  </div>

<script>
;(()=>{
  const $ = s=>document.querySelector(s);
  const boardEl=$('#board'), statusEl=$('#status'), banner=$('#banner'), toast=$('#toast');
  const moneyXEl=$('#moneyX'), moneyOEl=$('#moneyO'), mxEl=$('#mx'), moEl=$('#mo');
  const lastX=$('#lastX'), lastO=$('#lastO');
  const btnCreateLink=$('#btnCreateLink'), shareLinkEl=$('#shareLink'), rtcEl=$('#rtc');
  const btnBid=$('#btnBid'), btnNextMatch=$('#btnNextMatch');
  const bidModal=$('#bidModal'), bidInput=$('#bidInput'), btnSubmitBid=$('#btnSubmitBid');
  const roundModal=$('#roundModal'), roundBody=$('#roundBody'), roundOk=$('#roundOk');
  const winModal=$('#winModal'), winTitle=$('#winTitle'), winReason=$('#winReason'), btnNextMatch2=$('#btnNextMatch2'), btnCloseWin=$('#btnCloseWin'), sumScore=$('#sumScore');
  const nameX=$('#nameX'), nameO=$('#nameO'), sHost=$('#sHost'), sGuest=$('#sGuest');
  const chatLog=$('#chatLog'), chatText=$('#chatText'), chatSend=$('#chatSend');

  const lines=()=>[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  function checkWin(board){ for(const [a,b,c] of lines()) if(board[a]&&board[a]===board[b]&&board[a]===board[c]) return board[a]; if(board.every(x=>x)) return 'F'; return '' }

  let S = {
    board:Array(9).fill(''),
    money:{X:100,O:100},
    lastBid:{X:0,O:0},
    startBudget:100,
    matchNo:1,
    phase:'idle',
    pending:null,
    bids:{},
    lastWin:null,
    roundNo:0,
    lastRound:null,
    score:{host:{name:'',wins:0}, guest:{name:'',wins:0}}
  };
  let local = { role:'?', isHost:false, connected:false, myName:'', waiting:false, lastRoundSeen:0, winShownFor:0 };

  function toastMsg(msg, kind='good', ms=1600){ toast.textContent=msg; toast.className='toast show '+(kind==='bad'?'bad':'good'); setTimeout(()=>toast.className='toast', ms); }

  function updateNames(){
    nameX.textContent = 'X: ' + ((local.isHost? local.myName:S.score.host.name) || '—');
    nameO.textContent = 'O: ' + ((!local.isHost? local.myName:S.score.guest.name) || '—');
    sHost.textContent = S.score.host.wins; sGuest.textContent = S.score.guest.wins;
  }
  function updateMeters(){
    moneyXEl.textContent=S.money.X.toFixed(0); moneyOEl.textContent=S.money.O.toFixed(0);
    lastX.textContent=S.lastBid.X.toFixed(0); lastO.textContent=S.lastBid.O.toFixed(0);
    mxEl.style.width=Math.max(0,Math.min(100,(S.money.X/S.startBudget)*100))+'%';
    moEl.style.width=Math.max(0,Math.min(100,(S.money.O/S.startBudget)*100))+'%';
  }
  function render(){
    boardEl.innerHTML='';
    S.board.forEach((v,i)=>{
      const canPlace = S.phase==='placing' && S.pending && !v && S.pending.winner===local.role;
      const d=document.createElement('div'); d.className='cell'+(v?' '+(v==='X'?'x':'o'):' empty')+(canPlace?' placeable':''); d.textContent=v||i;
      d.addEventListener('click',()=>{ if(canPlace){ if(local.isHost) hostPlace(i); else send({type:'PLACE', i}); } });
      boardEl.appendChild(d);
    });
    updateMeters(); updateNames();
    const phaseText = S.phase==='bidding' ? 'Bidding — click "Bid for Next Round"' : S.phase==='placing' ? (S.pending? (S.pending.winner + ' to place') : 'Placing…') : S.phase==='ended' ? 'Finished' : 'Not connected';
    statusEl.textContent = phaseText;
    banner.textContent = local.connected ? ('Match #' + S.matchNo) : 'Not connected';
    btnBid.disabled = !(local.connected && S.phase==='bidding' && typeof S.bids[local.role] !== 'number');
    btnNextMatch.disabled = !(local.connected && S.phase==='ended' && local.isHost);
    if(S.lastRound && S.lastRound.roundNo && local.lastRoundSeen !== S.lastRound.roundNo){
      roundBody.innerHTML = 'X bid $' + S.lastRound.bx.toFixed(0) + ' • O bid $' + S.lastRound.bo.toFixed(0) + '<br><br><b>' + S.lastRound.winner + '</b> wins and may place.';
      roundModal.classList.add('show');
      local.lastRoundSeen = S.lastRound.roundNo;
      local.waiting=false;
    }
  }

  function hideBid(){ bidModal.classList.remove('show'); }
  function hideRound(){ roundModal.classList.remove('show'); }
  function showWin(winner, reason){
    winTitle.textContent=(winner==='No one')?'DRAW':(winner + ' WINS!');
    winTitle.style.color=(winner==='X')?'var(--blue)':((winner==='O')?'var(--pink)':'#cfe5ff');
    winReason.textContent=reason;
    sumScore.textContent = S.score.host.wins + ' : ' + S.score.guest.wins;
    winModal.classList.add('show');
  }
  function hideWin(){ winModal.classList.remove('show'); }

  // Host-only transitions
  function startMatchHost(resetMoney=false){
    if(!local.isHost) return;
    if(resetMoney) S.money={X:S.startBudget,O:S.startBudget};
    S.board=Array(9).fill(''); S.bids={}; S.pending=null; S.lastWin=null; S.phase='bidding'; S.lastBid={X:0,O:0};
    S.roundNo=0; S.lastRound=null;
    sendState(); render();
  }
  function hostProcessBid(role, val){
    if(S.phase!=='bidding') return;
    const remain = role==='X'?S.money.X:S.money.O;
    S.bids[role]=Math.max(0, Math.min(remain, Number(val)||0));
    sendState();
    if(typeof S.bids.X==='number' && typeof S.bids.O==='number'){
      const bx=S.bids.X, bo=S.bids.O;
      S.money.X-=bx; S.money.O-=bo; S.lastBid.X=bx; S.lastBid.O=bo;
      const winner = bx>bo?'X':bo>bx?'O':(Math.random()<.5?'X':'O');
      S.pending = {winner,bx,bo}; S.phase='placing'; S.roundNo+=1; S.lastRound={bx,bo,winner,roundNo:S.roundNo};
      sendState(); render();
    }
  }
  function hostPlace(i){
    if(S.phase!=='placing' || !S.pending || S.board[i]) return;
    S.board[i]=S.pending.winner;
    const w=checkWin(S.board);
    if(w==='X'||w==='O'){
      S.phase='ended'; S.lastWin={winner:w, reason:'Standard Win (3-in-a-row)'};
      const side = (w==='X')?'host':'guest'; S.score[side].wins += 1;
    } else if(w==='F'){
      S.phase='ended';
      const reason=(S.money.X>S.money.O)?'Economic Win (more money)':
                    (S.money.O>S.money.X)?'Economic Win (more money)':'Draw';
      const winner=(S.money.X>S.money.O)?'X':(S.money.O>S.money.X)?'O':'No one';
      S.lastWin={winner,reason}; if(winner!=='No one'){ const side=(winner==='X')?'host':'guest'; S.score[side].wins += 1; }
    } else if(S.money.X<=0 || S.money.O<=0){
      const winner=S.money.X<=0 && S.money.O<=0?'No one':(S.money.X<=0?'O':'X');
      const reason=(winner==='No one')?'Draw — both bankrupt':'Bankruptcy';
      S.phase='ended'; S.lastWin={winner,reason}; if(winner!=='No one'){ const side=(winner==='X')?'host':'guest'; S.score[side].wins += 1; }
    } else {
      S.bids={}; S.pending=null; S.phase='bidding';
    }
    sendState(); render();
    if(S.phase==='ended'){ showWin(S.lastWin.winner, S.lastWin.reason); }
  }

  // Networking
  let peer=null, conn=null;
  function setRTC(s){ rtcEl.textContent=s }
  function makePeer(id){ return new Peer(id, { host:'0.peerjs.com', port:443, path:'/', secure:true }); }
  function send(obj){ if(conn && conn.open){ try{ conn.send(obj); }catch(e){} } }
  function sendState(){ send({type:'STATE', S}); }

  function bindConnection(c){
    conn=c;
    c.on('open', ()=>{
      local.connected=true; setRTC('Connected'); toastMsg('Connected ✅','good');
      askName((name)=>{
        if(local.isHost){ local.myName=name; S.score.host.name=name; send({type:'NAME', who:'host', name}); startMatchHost(true); }
        else { local.myName=name; S.score.guest.name=name; send({type:'NAME', who:'guest', name}); send({type:'PING'}); }
        updateNames(); render();
      });
    });
    c.on('data', msg=>{
      if(msg.type==='PING'){ if(local.isHost) sendState(); return; }
      if(msg.type==='STATE'){ S = msg.S; updateNames(); render(); return; }
      if(msg.type==='NAME'){ if(local.isHost){ S.score[msg.who].name = msg.name; sendState(); } updateNames(); return; }
      if(msg.type==='BID' && local.isHost){ hostProcessBid(msg.role, msg.value); return; }
      if(msg.type==='PLACE' && local.isHost){ hostPlace(msg.i); return; }
      if(msg.type==='NEXT' && local.isHost){ S.matchNo++; startMatchHost(false); return; }
      if(msg.type==='CHAT'){ addChat(msg.from, msg.text, false); return; }
    });
    c.on('close', ()=>{ local.connected=false; setRTC('Disconnected'); toastMsg('Disconnected ❌','bad',2200); });
    c.on('error', ()=>{ setRTC('Error'); toastMsg('Connection error','bad',2200); });
  }

  // Chat
  function addChat(who, text, mine){
    const div=document.createElement('div'); div.className='chatRow ' + (mine?'chatMine':'chatOther');
    div.textContent = who+': '+text; chatLog.appendChild(div); chatLog.scrollTop=chatLog.scrollHeight;
  }
  chatSend.addEventListener('click', ()=>{
    const t = chatText.value.trim(); if(!t) return; chatText.value='';
    addChat(local.myName, t, true); send({type:'CHAT', from: local.myName, text:t});
  });
  chatText.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ chatSend.click(); }});

  // UI Actions
  btnBid.addEventListener('click', ()=>{
    if(!(local.connected && S.phase==='bidding' && typeof S.bids[local.role] !== 'number')) return;
    bidModal.classList.add('show'); bidInput.value=''; setTimeout(()=>bidInput.focus(),20);
  });
  btnSubmitBid.addEventListener('click', ()=>{
    const v=parseFloat(bidInput.value||'0'); bidModal.classList.remove('show');
    const remain = local.role==='X'?S.money.X:S.money.O;
    if(isNaN(v) || v<0 || v>remain) return alert('Invalid bid');
    if(local.isHost) hostProcessBid(local.role, v); else send({type:'BID', role: local.role, value: v});
  });
  roundOk.addEventListener('click', ()=> hideRound());
  btnNextMatch.addEventListener('click', ()=>{ if(local.isHost){ S.matchNo++; startMatchHost(false); } else { send({type:'NEXT'}); } hideWin(); });
  btnNextMatch2.addEventListener('click', ()=>{ btnNextMatch.click(); });
  btnCloseWin.addEventListener('click', ()=> hideWin());

  // Create/join with explicit role fix
  function createShareLink(){
    const key='room-'+Math.random().toString(36).slice(2,8);
    const link=location.origin+location.pathname+'?key='+encodeURIComponent(key);
    shareLinkEl.value=link; navigator.clipboard.writeText(link).catch(()=>{});
    local.isHost=true; local.role='X';
    peer = makePeer(key);
    setRTC('Hosting…');
    peer.on('open', ()=> setRTC('Waiting for guest…'));
    peer.on('connection', c=> bindConnection(c));
    render();
  }
  function joinFromKey(k){
    local.isHost=false; local.role='O';
    peer = makePeer();
    setRTC('Connecting…');
    peer.on('open', ()=>{ const c=peer.connect(k); bindConnection(c); });
    render();
  }

  function askName(cb){
    let name = '';
    while(!name){ name = prompt('Enter your display name:'); if(name===null){ name='Player'; break; } name = name.trim(); }
    cb(name);
  }

  btnCreateLink.addEventListener('click', createShareLink);
  window.addEventListener('load', ()=>{
    const k=new URLSearchParams(location.search).get('key');
    if(k){ joinFromKey(k); shareLinkEl.value = location.href; }
    render();
  });
})();
</script>
</body>
</html>
